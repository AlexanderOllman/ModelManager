{% extends "base.html" %}

{% block content %}
<h2 class="mt-4">Deploy Model</h2>
<div class="mb-3">
    <form id="pvcForm" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" id="pvcName" class="form-control" placeholder="PVC Name" required>
            </div>
            <div class="col-md-4">
                <input type="text" id="pvcNamespace" class="form-control" placeholder="PVC Namespace" required>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">Mount PVC</button>
            </div>
        </div>
    </form>
    <input type="text" id="modelSearch" class="form-control" placeholder="Search models">
</div>
<div id="models-container" class="row">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function createModelCards(data) {
        const container = document.getElementById('models-container');
        container.innerHTML = '';
        if (data.error) {
            container.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
        }
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-4';
            card.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">${item.name}</h5>
                        <p class="card-text">Size: ${item.size}</p>
                        <button class="btn btn-primary deploy-btn" data-model="${item.name}">Deploy</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        // Add event listeners for deploy buttons
        document.querySelectorAll('.deploy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modelName = e.target.getAttribute('data-model');
                // TODO: Implement deployment logic
                console.log(`Deploying model: ${modelName}`);
            });
        });
    }

    function filterModels() {
        const searchTerm = document.getElementById('modelSearch').value.toLowerCase();
        const cards = document.querySelectorAll('#models-container .col-md-4');
        cards.forEach(card => {
            const name = card.querySelector('.card-title').textContent.toLowerCase();
            if (name.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    function loadModels(pvcName, pvcNamespace) {
        fetch(`/api/pvc-models?pvc=${pvcName}&namespace=${pvcNamespace}`)
            .then(response => response.json())
            .then(data => {
                createModelCards(data);
                document.getElementById('modelSearch').addEventListener('input', filterModels);
            });
    }

    document.getElementById('pvcForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const pvcName = document.getElementById('pvcName').value;
        const pvcNamespace = document.getElementById('pvcNamespace').value;
        loadModels(pvcName, pvcNamespace);
    });
</script>
{% endblock %}