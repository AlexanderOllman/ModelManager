{% extends "base.html" %}

{% block content %}
<h2 class="mt-4">Deploy Model</h2>
<div class="mb-3">
    <input type="text" id="modelSearch" class="form-control" placeholder="Search models">
</div>
<div id="models-container" class="row">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function getK8sDomain() {
        const fullDomain = window.location.hostname;
        const parts = fullDomain.split('.');
        // Remove the 'model-manager' subdomain
        parts.shift();
        return parts.join('.');
    }

    function createModelCards(data) {
        const container = document.getElementById('models-container');
        container.innerHTML = '';
        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-4';
            card.innerHTML = `
                <div class="card h-100">
                    <div class="image-container">
                        <img src="data:image/png;base64,${item.logoImage}" class="card-img-top" alt="${item.displayName}">
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">${item.displayName}</h5>
                        <p class="card-text flex-grow-1">${item.description}</p>
                        <div class="mt-auto">
                            <p class="card-text"><small class="text-muted">Version: ${item.version}</small></p>
                            <p class="card-text"><small class="text-muted">Size: ${item.modelSize}</small></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary">Deploy</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary">Details</button>
                                </div>
                                <span class="badge bg-${item.status === 'ready' ? 'success' : 'warning'}">${item.status}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function filterModels() {
        const searchTerm = document.getElementById('modelSearch').value.toLowerCase();
        const cards = document.querySelectorAll('#models-container .col-md-4');
        cards.forEach(card => {
            const title = card.querySelector('.card-title').textContent.toLowerCase();
            const description = card.querySelector('.card-text').textContent.toLowerCase();
            if (title.includes(searchTerm) || description.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    const k8sDomain = getK8sDomain();
    fetch(`https://home.${k8sDomain}/api/v1/ai-applications`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            createModelCards(data);
            document.getElementById('modelSearch').addEventListener('input', filterModels);
        })
        .catch(error => {
            console.error('Error fetching model data:', error);
            document.getElementById('models-container').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger" role="alert">
                        Error loading models. Please try again later. Details: ${error.message}
                    </div>
                </div>
            `;
        });
</script>
{% endblock %}

{% block styles %}
<style>
    .card {
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .image-container {
        height: 200px;
        overflow: hidden;
    }
    .card-img-top {
        object-fit: cover;
        height: 100%;
        width: 100%;
    }
    .card-body {
        display: flex;
        flex-direction: column;
    }
    .card-text {
        flex-grow: 1;
    }
    .btn-group {
        margin-top: 10px;
    }
</style>
{% endblock %}