{% extends "base.html" %}

{% block content %}
<h2 class="mt-4">Models</h2>
<div class="mb-3 d-flex justify-content-between align-items-center">
    <input type="text" id="modelSearch" class="form-control w-75" placeholder="Search by name or namespace">
    <button id="addModelBtn" class="btn btn-primary">Add Model</button>
</div>
<div id="models-container">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Success Modal -->
<div id="copySuccessModal" class="copy-success-modal" style="display: none;">
    <span id="copySuccessMessage"></span>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this model?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function safeGet(obj, path, defaultValue = 'N/A') {
    try {
        return path.split('.').reduce((o, k) => (o || {})[k], obj) || defaultValue;
    } catch (error) {
        return defaultValue;
    }
}

function getFrameworkTag(item) {
    const model = safeGet(item, 'spec.predictor.model.modelFormat.name', '').toLowerCase();
    if (model.includes('llama') || model.includes('nvidia-nim')) {
        return 'LL';
    } else if (model.includes('tensorflow')) {
        return 'TF';
    } else if (model.includes('pytorch')) {
        return 'PT';
    } else if (model.includes('onnx')) {
        return 'ONNX';
    } else {
        return 'DI';
    }
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    } catch (error) {
        return 'N/A';
    }
}

function truncateUrl(url) {
    if (!url) return 'N/A';
    if (url.length > 50) {
        return url.substring(0, 47) + '...';
    }
    return url;
}

function createModelCards(data) {
    const container = document.getElementById('models-container');
    container.innerHTML = '';
    
    if (!data.items || data.items.length === 0) {
        container.innerHTML = '<p>No models found.</p>';
        return;
    }

    data.items.forEach(item => {
        const readyCondition = safeGet(item, 'status.conditions', []).find(c => c.type === 'Ready');
        const isReady = readyCondition && readyCondition.status === 'True';
        const url = safeGet(item, 'status.url');
        
        const card = document.createElement('div');
        card.className = 'model-card';
        card.dataset.url = url;
        
        card.innerHTML = `
            <div class="status-badge ${isReady ? 'ready' : 'not-ready'}">
                ${isReady ? 'Ready' : 'Not Ready'}
            </div>
            
            <div class="deployment-date">
                Deployed ${formatDate(safeGet(item, 'metadata.creationTimestamp'))}
            </div>
            
            <div class="model-name">
                ${safeGet(item, 'metadata.name')}
            </div>
            
            <div class="field-label">
                Namespace:
            </div>
            <div class="field-value">
                ${safeGet(item, 'metadata.namespace')}
            </div>
            
            <div class="field-label">
                Endpoint URL:
            </div>
            <div class="field-value">
                ${truncateUrl(url)}
            </div>
            
            <div class="framework-tag">
                ${getFrameworkTag(item)}
            </div>
        `;

        container.appendChild(card);
    });
}

function showCopySuccess(modelName) {
    const modal = document.getElementById('copySuccessModal');
    const message = document.getElementById('copySuccessMessage');
    message.textContent = `${modelName} endpoint URL copied to clipboard!`;
    modal.style.display = 'block';
    
    setTimeout(() => {
        modal.style.display = 'none';
    }, 2000);
}

function filterModels() {
    const searchTerm = document.getElementById('modelSearch').value.toLowerCase();
    document.querySelectorAll('.model-card').forEach(card => {
        const name = card.querySelector('.model-name').textContent.toLowerCase();
        const namespace = card.querySelector('.field-value').textContent.toLowerCase();
        if (name.includes(searchTerm) || namespace.includes(searchTerm)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// Event Listeners
document.getElementById('modelSearch').addEventListener('input', filterModels);

document.addEventListener('click', function(e) {
    const modelCard = e.target.closest('.model-card');
    if (!modelCard) return;
    
    const url = modelCard.dataset.url;
    const modelName = modelCard.querySelector('.model-name').textContent.trim();
    
    navigator.clipboard.writeText(url).then(() => {
        showCopySuccess(modelName);
    }).catch(err => {
        console.error('Failed to copy text:', err);
    });
});

// Initial load
fetch('/api/isvc')
    .then(response => response.json())
    .then(data => createModelCards(data))
    .catch(error => {
        console.error('Error loading models:', error);
        document.getElementById('models-container').innerHTML = 
            '<p>Error loading models. Please try again later.</p>';
    });
</script>
{% endblock %}