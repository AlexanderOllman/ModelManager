{% extends "base.html" %}

{% block content %}
<h2 class="mt-4">Models</h2>
<div class="mb-3">
    <input type="text" id="modelSearch" class="form-control" placeholder="Search by name or namespace">
</div>
<div id="models-container" class="row">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.card {
  --push: 8px;
  width: 320px;
  border: 1px solid black;
  border-radius: 12px;
  padding: 20px;
  background-color: white;
  display: flex;
  flex-direction: column;
  gap: 14px;
  cursor: pointer;
  position: relative;
  transition: box-shadow 0.15s ease-in-out, transform 0.15s ease-in-out;
  box-shadow: var(--push) var(--push) 0 0 black;
  will-change: box-shadow, transform;
  margin-bottom: 30px;
}
.card:hover {
  --push: 4px;
  box-shadow: var(--push) var(--push) 0 0 black;
  transform: translate(var(--push), var(--push));
}
.card:active {
  box-shadow: 0 0 0 0 black;
  transform: translate(8px, 8px);
}
.image-container {
  background-color: SandyBrown;
  width: 100%;
  height: 160px;
  border-radius: 8px;
  overflow: hidden;
}
.tag {
  background-color: SandyBrown;
  align-self: flex-start;
  border-radius: 4px;
  padding: 8px 10px;
  font-size: 12px;
  font-weight: bold;
  letter-spacing: 0.25px;
}
.card h1 {
  margin: 8px 0;
  font-size: 20px;
}
.publication-date {
  font-size: 14px;
  color: rgba(0, 0, 0, 0.75);
}
.card p {
  margin: 0;
  font-size: 14px;
  color: rgba(0, 0, 0, 0.65);
  line-height: 1.5;
}
.user-info {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
}
.copy-icon {
  cursor: pointer;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    function copyToClipboard(text, event) {
        navigator.clipboard.writeText(text).then(() => {
            const popup = document.createElement('div');
            popup.textContent = 'URL copied!';
            popup.style.position = 'fixed';
            popup.style.padding = '10px';
            popup.style.background = 'rgba(0,0,0,0.8)';
            popup.style.color = 'white';
            popup.style.borderRadius = '5px';
            popup.style.zIndex = '1000';
            document.body.appendChild(popup);

            const rect = event.target.getBoundingClientRect();
            popup.style.top = `${rect.top - 40}px`;
            popup.style.left = `${rect.left}px`;

            setTimeout(() => {
                document.body.removeChild(popup);
            }, 2000);
        });
    }

    function createModelCards(data) {
        const container = document.getElementById('models-container');
        container.innerHTML = '';
        data.items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-4';
            const deploymentTime = new Date(item.metadata.creationTimestamp).toLocaleString();
            const isReady = item.status.conditions.find(c => c.type === 'Ready').status === 'True';
            card.innerHTML = `
                <div class="card">
                    <div class="image-container">
                        <div class="image"></div>
                    </div>
                    <div class="tag">
                        <span>${isReady ? 'Ready' : 'Not Ready'}</span>
                    </div>
                    <div class="publication-date">
                        <span>Deployed ${deploymentTime}</span>
                    </div>
                    <h1>${item.metadata.name}</h1>
                    <p>Namespace: ${item.metadata.namespace}</p>
                    <div class="user-info">
                        <span>URL: ${item.status.url}</span>
                        <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${item.status.url}', event)"></i>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function filterModels() {
        const searchTerm = document.getElementById('modelSearch').value.toLowerCase();
        const cards = document.querySelectorAll('#models-container .col-md-4');
        cards.forEach(card => {
            const name = card.querySelector('h1').textContent.toLowerCase();
            const namespace = card.querySelector('p').textContent.toLowerCase();
            if (name.includes(searchTerm) || namespace.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    fetch('/api/isvc')
        .then(response => response.json())
        .then(data => {
            createModelCards(data);
            document.getElementById('modelSearch').addEventListener('input', filterModels);
        });
</script>
{% endblock %}